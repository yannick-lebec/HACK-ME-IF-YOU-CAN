<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Hack Me If You Can - Levels</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body class="game-body">
    <div class="game-container">
      <h1>Hack Me If You Can üòà</h1>
      <p class="subtitle">
        Bienvenue dans ton mini-CTF web. Connecte-toi pour garder ton score.
      </p>

      <div class="login-box" id="login-box">
        <h2>Connexion joueur</h2>
        <form action="/login-safe" method="POST" class="login-form">
          <input
            type="text"
            name="username"
            placeholder="Nom d'utilisateur"
            required
          />
          <input
            type="password"
            name="password"
            placeholder="Mot de passe"
            required
          />
          <button type="submit" class="btn">Se connecter</button>
        </form>

        <p id="login-error" class="error-message" style="display: none"></p>

        <p class="hint">
          Pas encore de compte ?
          <a href="/register-safe">Cr√©er un compte</a>
        </p>
      </div>

      <div class="login-box" id="welcome-box" style="display: none">
        <h2 id="welcome-text"></h2>
        <form action="/logout" method="POST">
          <button type="submit" class="btn btn-secondary">D√©connexion</button>
        </form>
      </div>

      <p class="score">Score : <span id="score-value">0</span> / 10 niveaux</p>

      <form action="/reset-game" method="POST" class="reset-form">
        <button type="submit" class="btn btn-secondary">
          Recommencer le jeu üîÅ
        </button>
      </form>

      <div class="levels">
        <div class="level-card">
          <h2>Level 1 ‚Äì SQL Injection Login</h2>
          <p>R√©ussis √† te connecter sans conna√Ætre le mot de passe.</p>

          <div class="level-actions">
            <a href="/level1" class="btn">Jouer ce niveau</a>

            <form
              action="/check-flag-level1"
              method="POST"
              class="flag-form"
              id="level1-flag-form"
            >
              <input
                type="text"
                name="flag"
                placeholder="Entre le flag ici"
                required
                class="flag-input"
              />
              <button type="submit" class="btn btn-secondary">Valider</button>
              <span id="level1-result" class="flag-result"></span>
            </form>
          </div>
        </div>
        <div class="level-card">
          <h2>Level 2 ‚Äì XSS (Reflected)</h2>
          <p>Exploit une vuln√©rabilit√© XSS avec le param√®tre <code>q</code>.</p>

          <div class="level-actions">
            <a href="/level2" class="btn">Jouer ce niveau</a>

            <form
              action="/check-flag-level2"
              method="POST"
              class="flag-form"
              id="level2-flag-form"
            >
              <input
                type="text"
                name="flag"
                placeholder="Entre le flag ici"
                required
                class="flag-input"
              />
              <button type="submit" class="btn btn-secondary">Valider</button>
              <span id="level2-result" class="flag-result"></span>
            </form>
          </div>
        </div>
        <!-- LEVEL 3 -->
        <div class="level-card">
          <h2>Level 3 ‚Äì XSS (Stock√©)</h2>
          <p>
            Objectif : exploite une <strong>XSS stock√©e</strong> dans un mur de
            commentaires.<br> Ton script doit s'ex√©cuter √† chaque fois que la page
            se charge.
          </p>

          <div class="level-actions">
            <a href="/level3" class="btn">Jouer ce niveau</a>

            <form
              action="/check-flag-level3"
              method="POST"
              class="flag-form"
              id="level3-flag-form"
            >
              <input
                type="text"
                name="flag"
                placeholder="Entre le flag ici"
                required
                class="flag-input"
              />
              <button type="submit" class="btn btn-secondary">Valider</button>
              <span id="level3-result" class="flag-result"></span>
            </form>
          </div>
        </div>

        <!-- Plus tard on ajoutera les autres niveaux -->
        <!-- Level 2, XSS, IDOR, etc. -->
      </div>
    </div>
    <script>
      // 1) R√©cup√©rer score + niveaux compl√©t√©s
      fetch("/score")
        .then((res) => {
          if (res.status === 401 || res.status === 403) {
            return null; // pas connect√©
          }
          return res.json();
        })
        .then((data) => {
          if (!data) return;

          // Score affich√©
          const scoreSpan = document.getElementById("score-value");
          if (scoreSpan) scoreSpan.textContent = data.score;

          // Masquer connexion & afficher profil
          const loginBox = document.getElementById("login-box");
          const welcomeBox = document.getElementById("welcome-box");
          const welcomeText = document.getElementById("welcome-text");

          if (data.username) {
            if (loginBox) loginBox.style.display = "none";
            if (welcomeBox) welcomeBox.style.display = "block";
            if (welcomeText)
              welcomeText.textContent = `Bonjour, ${data.username} üëã`;
          }

          // === RESTAURATION DES FLAGS LEVELS ===

          // Level 1
          if (data.completedLevels.includes(1)) {
            const result1 = document.getElementById("level1-result");
            if (result1) {
              result1.textContent = "D√©fi termin√© ‚úîÔ∏è";
              result1.style.color = "#22c55e";
            }
          }

          // Level 2
          if (data.completedLevels.includes(2)) {
            const result2 = document.getElementById("level2-result");
            if (result2) {
              result2.textContent = "D√©fi termin√© ‚úîÔ∏è";
              result2.style.color = "#22c55e";
            }
          }
          // Level 3
          if (data.completedLevels.includes(3)) {
            const result3 = document.getElementById("level3-result");
            if (result3) {
              result3.textContent = "D√©fi termin√© ‚úîÔ∏è";
              result3.style.color = "#22c55e";
            }
          }
        })
        .catch((err) => console.error("Erreur score :", err));

      // === LEVEL 1 FLAG ===
      const level1Form = document.getElementById("level1-flag-form");
      if (level1Form) {
        level1Form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const form = e.target;
          const flagInput = form.flag.value;
          const resultSpan = document.getElementById("level1-result");
          const scoreSpan = document.getElementById("score-value");

          const res = await fetch("/check-flag-level1", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `flag=${encodeURIComponent(flagInput)}`,
          });

          const data = await res.json();

          if (data.success) {
            resultSpan.textContent = "D√©fi termin√© ‚úîÔ∏è";
            resultSpan.style.color = "#22c55e";

            // Mise √† jour du score
            const scoreRes = await fetch("/score");
            if (scoreRes.ok && scoreSpan) {
              const scoreData = await scoreRes.json();
              scoreSpan.textContent = scoreData.score;
            }
          } else {
            resultSpan.textContent = "Mauvais flag ‚ùå";
            resultSpan.style.color = "#ef4444";
          }
        });
      }

      // === LEVEL 2 FLAG ===
      const level2Form = document.getElementById("level2-flag-form");
      if (level2Form) {
        level2Form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const form = e.target;
          const flagInput = form.flag.value;
          const resultSpan = document.getElementById("level2-result");
          const scoreSpan = document.getElementById("score-value");

          const res = await fetch("/check-flag-level2", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `flag=${encodeURIComponent(flagInput)}`,
          });

          const data = await res.json();

          if (data.success) {
            resultSpan.textContent = "D√©fi termin√© ‚úîÔ∏è";
            resultSpan.style.color = "#22c55e";

            // Mise √† jour du score
            const scoreRes = await fetch("/score");
            if (scoreRes.ok && scoreSpan) {
              const scoreData = await scoreRes.json();
              scoreSpan.textContent = scoreData.score;
            }
          } else {
            resultSpan.textContent = "Mauvais flag ‚ùå";
            resultSpan.style.color = "#ef4444";
          }
        });
      }
      // === LEVEL 3 FLAG ===
      const level3Form = document.getElementById("level3-flag-form");
      if (level3Form) {
        level3Form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const form = e.target;
          const flagInput = form.flag.value;
          const resultSpan = document.getElementById("level3-result");
          const scoreSpan = document.getElementById("score-value");

          const res = await fetch("/check-flag-level3", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `flag=${encodeURIComponent(flagInput)}`,
          });

          const data = await res.json();

          if (data.success) {
            resultSpan.textContent = "D√©fi termin√© ‚úîÔ∏è";
            resultSpan.style.color = "#22c55e";

            const scoreRes = await fetch("/score");
            if (scoreRes.ok && scoreSpan) {
              const scoreData = await scoreRes.json();
              scoreSpan.textContent = scoreData.score;
            }
          } else {
            resultSpan.textContent = "Mauvais flag ‚ùå";
            resultSpan.style.color = "#ef4444";
          }
        });
      }
    </script>
  </body>
</html>
