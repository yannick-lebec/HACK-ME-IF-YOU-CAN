<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Hack Me If You Can - Levels</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body class="game-body">
    <div class="game-container">
      <h1>Hack Me If You Can üòà</h1>
      <p class="subtitle">
        Bienvenue dans ton mini-CTF web. Connecte-toi pour garder ton score.
      </p>

      <!-- Box de connexion -->
      <div class="login-box" id="login-box">
        <h2>Connexion joueur</h2>
        <form action="/login-safe" method="POST" class="login-form">
          <input
            type="text"
            name="username"
            placeholder="Nom d'utilisateur"
            required
          />
          <input
            type="password"
            name="password"
            placeholder="Mot de passe"
            required
          />
          <button type="submit" class="btn">Se connecter</button>
        </form>

        <p id="login-error" class="error-message" style="display: none"></p>

        <p class="hint">
          Pas encore de compte ?
          <a href="/register-safe">Cr√©er un compte</a>
        </p>
      </div>

      <!-- Box bienvenue -->
      <div class="login-box" id="welcome-box" style="display: none">
        <h2 id="welcome-text"></h2>
        <form action="/logout" method="POST">
          <button type="submit" class="btn btn-secondary">D√©connexion</button>
        </form>
      </div>

      <!-- Score -->
      <p class="score">Score : <span id="score-value">0</span> / 5 niveaux</p>

      <!-- Reset jeu -->
      <form action="/reset-game" method="POST" class="reset-form">
        <button type="submit" class="btn btn-secondary">
          Recommencer le jeu üîÅ
        </button>
      </form>

      <!-- Niveaux -->
      <div class="levels">
        <!-- LEVEL 1 -->
        <div class="level-card">
          <h2>Level 1 ‚Äì SQL Injection Login</h2>
          <p>R√©ussis √† te connecter sans conna√Ætre le mot de passe.</p>

          <div class="level-actions">
            <a href="/level1" class="btn">Jouer ce niveau</a>

            <a href="/explain/level1" class="btn btn-secondary">
              üß† Explication
            </a>

            <form
              action="/check-flag-level1"
              method="POST"
              class="flag-form"
              id="level1-flag-form"
            >
              <input
                type="text"
                name="flag"
                placeholder="Entre le flag ici"
                required
                class="flag-input"
              />
              <button type="submit" class="btn btn-secondary">Valider</button>
              <span id="level1-result" class="flag-result"></span>
            </form>
          </div>
        </div>

        <!-- LEVEL 2 -->
        <div class="level-card">
          <h2>Level 2 ‚Äì XSS (Reflected)</h2>
          <p>
            Exploit une vuln√©rabilit√© <strong>XSS r√©fl√©chie</strong> avec le
            param√®tre <code>q</code>.
          </p>

          <div class="level-actions">
            <a href="/level2" class="btn">Jouer ce niveau</a>

            <a href="/explain/level2" class="btn btn-secondary">
              üß† Explication
            </a>

            <form
              action="/check-flag-level2"
              method="POST"
              class="flag-form"
              id="level2-flag-form"
            >
              <input
                type="text"
                name="flag"
                placeholder="Entre le flag ici"
                required
                class="flag-input"
              />
              <button type="submit" class="btn btn-secondary">Valider</button>
              <span id="level2-result" class="flag-result"></span>
            </form>
          </div>
        </div>

        <!-- LEVEL 3 -->
        <div class="level-card">
          <h2>Level 3 ‚Äì XSS (Stock√©)</h2>
          <p>
            Objectif : exploite une <strong>XSS stock√©e</strong> dans un mur de
            commentaires.<br />
            Ton script doit s'ex√©cuter √† chaque fois que la page se charge.
          </p>

          <div class="level-actions">
            <a href="/level3" class="btn">Jouer ce niveau</a>

            <a href="/explain/level3" class="btn btn-secondary">
              üß† Explication
            </a>

            <form
              action="/check-flag-level3"
              method="POST"
              class="flag-form"
              id="level3-flag-form"
            >
              <input
                type="text"
                name="flag"
                placeholder="Entre le flag ici"
                required
                class="flag-input"
              />
              <button type="submit" class="btn btn-secondary">Valider</button>
              <span id="level3-result" class="flag-result"></span>
            </form>
          </div>
        </div>

        <!-- LEVEL 4 -->
        <div class="level-card">
          <h2>Level 4 ‚Äì Broken Access Control</h2>
          <p>
            Objectif : acc√©der √† une zone <strong>admin</strong> alors que tu
            n'es pas administrateur. Le contr√¥le d'acc√®s est mal cod√©, essaie de
            le contourner.
          </p>

          <div class="level-actions">
            <a href="/level4" class="btn">Jouer ce niveau</a>

            <a href="/explain/level4" class="btn btn-secondary">
              üß† Explication
            </a>

            <form
              action="/check-flag-level4"
              method="POST"
              class="flag-form"
              id="level4-flag-form"
            >
              <input
                type="text"
                name="flag"
                placeholder="Entre le flag ici"
                required
                class="flag-input"
              />
              <button type="submit" class="btn btn-secondary">Valider</button>
              <span id="level4-result" class="flag-result"></span>
            </form>
          </div>
        </div>

        <!-- LEVEL 5 -->
        <div class="level-card">
          <h2>Level 5 ‚Äì IDOR</h2>
          <p>
            Objectif : afficher le profil de quelqu'un d'autre en modifiant un
            identifiant dans l'URL (fail tr√®s fr√©quent).
          </p>

          <div class="level-actions">
            <a href="/level5" class="btn">Jouer ce niveau</a>

            <a href="/explain/level5" class="btn btn-secondary">
              üß† Explication
            </a>

            <form
              action="/check-flag-level5"
              method="POST"
              class="flag-form"
              id="level5-flag-form"
            >
              <input
                type="text"
                name="flag"
                placeholder="Entre le flag ici"
                required
                class="flag-input"
              />
              <button type="submit" class="btn btn-secondary">Valider</button>
              <span id="level5-result" class="flag-result"></span>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Gestion message d'erreur de login s√©curis√©
      const params = new URLSearchParams(window.location.search);
      const loginError = params.get("loginError");
      const loginErrorEl = document.getElementById("login-error");

      if (loginError === "1" && loginErrorEl) {
        loginErrorEl.textContent = "‚ùå Identifiants incorrects";
        loginErrorEl.style.display = "block";

        const cleanUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, "", cleanUrl);
      }

      // 1) R√©cup√©rer score + niveaux compl√©t√©s
      fetch("/score")
        .then((res) => {
          if (res.status === 401 || res.status === 403) {
            return null; // pas connect√©
          }
          return res.json();
        })
        .then((data) => {
          if (!data) return;

          // Score affich√©
          const scoreSpan = document.getElementById("score-value");
          if (scoreSpan) scoreSpan.textContent = data.score;

          // Masquer connexion & afficher profil
          const loginBox = document.getElementById("login-box");
          const welcomeBox = document.getElementById("welcome-box");
          const welcomeText = document.getElementById("welcome-text");

          if (data.username) {
            if (loginBox) loginBox.style.display = "none";
            if (welcomeBox) welcomeBox.style.display = "block";
            if (welcomeText)
              welcomeText.textContent = `Bonjour, ${data.username} üëã`;
          }

          // === RESTAURATION DES FLAGS LEVELS ===

          // Level 1
          if (data.completedLevels.includes(1)) {
            const result1 = document.getElementById("level1-result");
            if (result1) {
              result1.textContent = "D√©fi termin√© ‚úîÔ∏è";
              result1.style.color = "#22c55e";
            }
          }

          // Level 2
          if (data.completedLevels.includes(2)) {
            const result2 = document.getElementById("level2-result");
            if (result2) {
              result2.textContent = "D√©fi termin√© ‚úîÔ∏è";
              result2.style.color = "#22c55e";
            }
          }

          // Level 3
          if (data.completedLevels.includes(3)) {
            const result3 = document.getElementById("level3-result");
            if (result3) {
              result3.textContent = "D√©fi termin√© ‚úîÔ∏è";
              result3.style.color = "#22c55e";
            }
          }

          // Level 4
          if (data.completedLevels.includes(4)) {
            const result4 = document.getElementById("level4-result");
            if (result4) {
              result4.textContent = "D√©fi termin√© ‚úîÔ∏è";
              result4.style.color = "#22c55e";
            }
          }

          // Level 5
          if (data.completedLevels.includes(5)) {
            const result5 = document.getElementById("level5-result");
            if (result5) {
              result5.textContent = "D√©fi termin√© ‚úîÔ∏è";
              result5.style.color = "#22c55e";
            }
          }
        })
        .catch((err) => console.error("Erreur score :", err));

      // === LEVEL 1 FLAG ===
      const level1Form = document.getElementById("level1-flag-form");
      if (level1Form) {
        level1Form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const form = e.target;
          const flagInput = form.flag.value;
          const resultSpan = document.getElementById("level1-result");
          const scoreSpan = document.getElementById("score-value");

          const res = await fetch("/check-flag-level1", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `flag=${encodeURIComponent(flagInput)}`,
          });

          const data = await res.json();

          if (data.success) {
            resultSpan.textContent = "D√©fi termin√© ‚úîÔ∏è";
            resultSpan.style.color = "#22c55e";

            const scoreRes = await fetch("/score");
            if (scoreRes.ok && scoreSpan) {
              const scoreData = await scoreRes.json();
              scoreSpan.textContent = scoreData.score;
            }
          } else {
            resultSpan.textContent = "Mauvais flag ‚ùå";
            resultSpan.style.color = "#ef4444";
          }
        });
      }

      // === LEVEL 2 FLAG ===
      const level2Form = document.getElementById("level2-flag-form");
      if (level2Form) {
        level2Form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const form = e.target;
          const flagInput = form.flag.value;
          const resultSpan = document.getElementById("level2-result");
          const scoreSpan = document.getElementById("score-value");

          const res = await fetch("/check-flag-level2", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `flag=${encodeURIComponent(flagInput)}`,
          });

          const data = await res.json();

          if (data.success) {
            resultSpan.textContent = "D√©fi termin√© ‚úîÔ∏è";
            resultSpan.style.color = "#22c55e";

            const scoreRes = await fetch("/score");
            if (scoreRes.ok && scoreSpan) {
              const scoreData = await scoreRes.json();
              scoreSpan.textContent = scoreData.score;
            }
          } else {
            resultSpan.textContent = "Mauvais flag ‚ùå";
            resultSpan.style.color = "#ef4444";
          }
        });
      }

      // === LEVEL 3 FLAG ===
      const level3Form = document.getElementById("level3-flag-form");
      if (level3Form) {
        level3Form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const form = e.target;
          const flagInput = form.flag.value;
          const resultSpan = document.getElementById("level3-result");
          const scoreSpan = document.getElementById("score-value");

          const res = await fetch("/check-flag-level3", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `flag=${encodeURIComponent(flagInput)}`,
          });

          const data = await res.json();

          if (data.success) {
            resultSpan.textContent = "D√©fi termin√© ‚úîÔ∏è";
            resultSpan.style.color = "#22c55e";

            const scoreRes = await fetch("/score");
            if (scoreRes.ok && scoreSpan) {
              const scoreData = await scoreRes.json();
              scoreSpan.textContent = scoreData.score;
            }
          } else {
            resultSpan.textContent = "Mauvais flag ‚ùå";
            resultSpan.style.color = "#ef4444";
          }
        });
      }

      // === LEVEL 4 FLAG ===
      const level4Form = document.getElementById("level4-flag-form");
      if (level4Form) {
        level4Form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const form = e.target;
          const flagInput = form.flag.value;
          const resultSpan = document.getElementById("level4-result");
          const scoreSpan = document.getElementById("score-value");

          const res = await fetch("/check-flag-level4", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `flag=${encodeURIComponent(flagInput)}`,
          });

          const data = await res.json();

          if (data.success) {
            resultSpan.textContent = "D√©fi termin√© ‚úîÔ∏è";
            resultSpan.style.color = "#22c55e";

            const scoreRes = await fetch("/score");
            if (scoreRes.ok && scoreSpan) {
              const scoreData = await scoreRes.json();
              scoreSpan.textContent = scoreData.score;
            }
          } else {
            resultSpan.textContent = "Mauvais flag ‚ùå";
            resultSpan.style.color = "#ef4444";
          }
        });
      }

      // === LEVEL 5 FLAG ===
      const level5Form = document.getElementById("level5-flag-form");
      if (level5Form) {
        level5Form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const form = e.target;
          const flagInput = form.flag.value;
          const resultSpan = document.getElementById("level5-result");
          const scoreSpan = document.getElementById("score-value");

          const res = await fetch("/check-flag-level5", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `flag=${encodeURIComponent(flagInput)}`,
          });

          const data = await res.json();

          if (data.success) {
            resultSpan.textContent = "D√©fi termin√© ‚úîÔ∏è";
            resultSpan.style.color = "#22c55e";

            const scoreRes = await fetch("/score");
            if (scoreRes.ok && scoreSpan) {
              const scoreData = await scoreRes.json();
              scoreSpan.textContent = scoreData.score;
            }
          } else {
            resultSpan.textContent = "Mauvais flag ‚ùå";
            resultSpan.style.color = "#ef4444";
          }
        });
      }
    </script>
  </body>
</html>